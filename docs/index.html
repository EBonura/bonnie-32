<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bonnie-engine :: PS1 Software Rasterizer</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #1a1a2e;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            outline: none;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #eee;
            font-family: monospace;
            font-size: 18px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <canvas id="glcanvas" tabindex="1"></canvas>
    <script src="mq_js_bundle.js"></script>
    <script>
        document.getElementById('glcanvas').addEventListener('contextmenu', e => e.preventDefault());

        // Bonnie engine file import/export functions
        // These use native browser localStorage directly

        // Import: open file picker and store result in localStorage for Rust to read
        window.bonnie_import_file = function() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.ron';
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        localStorage.setItem('_bonnie_import_data', e.target.result);
                        localStorage.setItem('_bonnie_import_filename', file.name);
                        localStorage.setItem('_bonnie_import_ready', 'true');
                        console.log('Import: file loaded into localStorage:', file.name);
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };

        // Export: receive data from Rust via sapp-jsutils JsObject
        window._bonnie_pending_export = null;
        window.bonnie_set_export_data = function(data_handle, filename_handle) {
            // sapp-jsutils passes handles to JS objects stored in wasm_exports.js_objects
            // We need to convert them to strings
            var data = wasm_exports.js_objects[data_handle];
            var filename = wasm_exports.js_objects[filename_handle];
            console.log('bonnie_set_export_data called, data type:', typeof data, 'filename:', filename);
            window._bonnie_pending_export = { data: data, filename: filename };
        };
        window.bonnie_export_file = function() {
            var exportData = window._bonnie_pending_export ? window._bonnie_pending_export.data : null;
            var exportFilename = window._bonnie_pending_export ? window._bonnie_pending_export.filename : null;

            console.log('Export called, data length:', exportData ? exportData.length : 0, 'filename:', exportFilename);
            if (exportData && exportFilename) {
                var blob = new Blob([exportData], {type: 'text/plain'});
                var url = URL.createObjectURL(blob);
                var a = document.createElement('a');
                a.href = url;
                a.download = exportFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                window._bonnie_pending_export = null;
            }
        };

        // Register as WASM imports so Rust can call them
        miniquad_add_plugin({
            register_plugin: function(importObject) {
                importObject.env.bonnie_import_file = window.bonnie_import_file;
                importObject.env.bonnie_set_export_data = window.bonnie_set_export_data;
                importObject.env.bonnie_export_file = window.bonnie_export_file;
            }
        });

        load("bonnie-rs.wasm");
    </script>
</body>
</html>
